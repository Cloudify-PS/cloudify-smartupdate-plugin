tosca_definitions_version: cloudify_dsl_1_3


imports:
  - http://cloudify.co/spec/cloudify/4.6/types.yaml
  - plugin:cloudify-smartupdate-plugin?version=1.0


inputs:

  instance_name:
    type: string
    default: demo-instance

  network_name:
    type: string
    default: demo-network

  subnet_name:
    type: string
    default: demo-subnet

  port_name:
    type: string
    default: demo-port

  port_ip:
    type: string
    default: 172.16.1.20

  enable_dhcp:
    type: boolean
    default: True

  dns_nameservers:
    default:
      - 8.8.8.8

  allocation_pools:
    default:
      - start: 172.16.1.2
        end: 172.16.1.254

  gateway_ip:
    type: string
    default: 172.16.1.1

  cidr:
    type: string
    default: 172.16.1.0/24


node_templates:

  smart_network:
    type: cloudify.nodes.SmartDeploymentProxy
    properties:
      resource_config:
        blueprint:
          external_resource: True
          id: network
        deployment:
          id: network
          inputs:
            network_name: { get_input: network_name }
            subnet_name: { get_input: subnet_name }
            enable_dhcp: { get_input: enable_dhcp }
            dns_nameservers: { get_input: dns_nameservers }
            allocation_pools: { get_input: allocation_pools }
            gateway_ip: { get_input: gateway_ip }
            cidr: { get_input: cidr }
            port_name: { get_input: port_name }
            port_ip: { get_input: port_ip }
          outputs:
            network_id: network_id
            network_name: network_name
            subnet_id: subnet_id
            subnet_name: subnet_name
            port_id: port_id
            port_name: port_name

  smart_instance:
    type: cloudify.nodes.SmartDeploymentProxy
    properties:
      resource_config:
        blueprint:
          external_resource: True
          id: instance
        deployment:
          id: instance
          inputs:
            instance_name: { get_input: instance_name }
            port_id: { get_attribute: [smart_network, deployment, outputs, port_id] }
          outputs:
            instance_id: instance_id
            instance_name: instance_name
            port_id: port_id
            port_name: port_name
    interfaces:
      cloudify.interfaces.update:
        update:
          inputs:
            resource_config:
              blueprint: { get_property: [ SELF, resource_config, blueprint ] }
              deployment: { get_property: [ SELF, resource_config, deployment ] }
              reexecute: { get_property: [ SELF, resource_config, reexecute ] }
              executions_start_args:
                blueprint_id: { get_property: [ SELF, resource_config, blueprint, id ] }
                skip_install: False
                skip_uninstall: False
                skip_reinstall: False
                force: True
                ignore_failure: False
                install_first: False
                inputs:
                  instance_name: { get_input: instance_name }
                  port_id: { get_attribute: [smart_network, deployment, outputs, port_id] }
                reinstall_list: []
                workflow_id: smart_execute_update
    relationships:
      - type: cloudify.relationships.smart_connected_to
        target: smart_network
